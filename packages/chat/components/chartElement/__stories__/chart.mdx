import { ArgTypes, Markdown, Meta } from '@storybook/blocks';
import { cdnJs, cdnCss } from '../../../../../globals/internal/storybook-cdn';
import * as ChartElementStories from './chartElement.stories';
import packageJson from '../../../package.json';

<Meta of={ChartElementStories} />

## Overview

**The Chart component renders a large variety of Charts by consuming Vega-lite JSON specifications in its `content` attribute. These can easily be generated by LLMs, enabling true conversation-based chart design, editing and streaming.**

Like all components in Carbon Labs, Charts are invoked inside the core Chat component but can easily be imported separately and used independently. By default the `carbonify` attribute is enabled which extensively edits the specification styling in order to recreate Carbon Charts styling. This overrides and edits all axis/legend/title/encoding/gradient/colorscale values to display the specification as a clone of classic Carbon Charts.

* Vega-lite reference: [vega.github.io](https://vega.github.io/vega-lite/)
* Carbon Charts reference: 
[charts.carbondesignsystem.com](https://charts.carbondesignsystem.com/?path=/story/docs--welcome)

**Feel free to contact Owen Cornec (on Slack or o.cornec@ibm.com) if you have any issues/questions**


## Merging Vega-lite and Carbon Charts

Due to it's longevity and popularity, most LLMs have a large training corpus on a variety of Vega-lite specifications. During our extensive testing in the IBM Research Visual AI Lab, we found this greatly improves reliability during LLM generation. Additionally, Vega only requires a single JSON object to display any type of chart, which forgoes the need for multiple context-dependent calls.

Meanwhile, Carbon Charts is an excellently designed, robust and production-ready library following core Carbon design guidelines. Regrettably without fine-tuning, generation accuracy is insufficient due to a lack of examples in common training data. Carbon Charts also requires a predefined HTML chart tag (such as &lt;AreaChart&gt; &lt;SimpleBarChart&gt; etc) as well as separate `options` and `data` fields. This requires multiple queries, with the additional complexity of shared context and custom doctoring/sanitization. 

This lead us to adopt a hybrid approach, using Vega-lite as a boilerplate for querying LLMs then programmatically adding and editing styling/interactions/sizing. **This component is not a replacement for Carbon Charts**: it is primarily meant to handle highly-variable LLM-generated content to allow creation and edits through conversation.

**Advantages:**
With Vega a single JSON object string is all that is needed, thus charts can be generated in a single call to a model. This enables quicker response times, product-ready reliability and token-by-token streaming. Additionally, Vega-specific features are now possible, such as repeating charts (Comparative chart over a matrix of data fields) and multi-layer charts (Multiple types of any chart layered in sequence). Finally, the `config` system allows us to strategically override styles globally, given the unpredictability of LLM responses it's imperative to retain specific changes requested by users and override styling randomly appended by the generation process.

**Disadvantages**
Some chart types in Classic Carbon Charts are not currently supported, such as WordClouds, Radar Charts, Treemaps, Network/Tree Diagrams and Alluvial/Flow charts. Touch/mobile features have not been tested and attributes are still subject to change. Features such as legend interactions to filter out data, viewing the source data as a table, locale support, and are not currently implemented as well. (subject to change)

## Installation

Here's a quick example to get you started.

### JS (via import)

```javascript
import '@carbon-labs/ai-chat-chart/es/index.js';
```

## Implementation

### &lt;clabs-chat-chart&gt; attributes and properties
<ArgTypes story="Playground"/>

### Independent Usage:

```html
<clabs-chat-chart
  content <!-- string: (default: empty) - Stringified JSON object defining a Vega-lite V5 chart specification. Specifications must contain $schema, data and encoding -->
  container-height = "500px" <!-- string: (default: "300px") - Valid CSS string to define chart height, applied to chart container while specification is automatically set to height="container" to fill the parent container height -->
  container-width = "100%" <!-- string: (default: "100%") - Same as container-height, a CSS string to define the width, applied to chart container  -->
  render-method <!-- string: (default: "canvas") render using "svg" (easier to inspect in the DOM) or "canvas" (better performance) -->
  theme = "dark" <!-- string (default: "dark") - This value is either "dark" or "light" and displays the chart using Carbon Chart theme colors. -->
  carbonify <!-- boolean: (default: true) - extensively redefine the "config" field of the specification to apply Carbon Chart styling to chart defined in the specification (may override user-defined color/gradient/scale selections) -->
  enable-legend-filtering  <!-- boolean (default:false) - enable filtering of data points when clicking legend -->
  enable-tooltip <!-- boolean (default:false) - enable tooltip in the chart component -->
  enable-zooming <!-- boolean (default:false) - enable user-zooming in the chart component -->
  enable-brushing <!-- boolean (default:false) - enable user-brush selection to fetch groups of elements -->
  disable-options <!-- boolean (default: false) - disable all chart option buttons, supercedes all other individual button options below -->
  disable-fullscreen <!-- boolean (default: false) - hide fullscreen button  -->
  disable-editor <!-- boolean (default: false) - hide vega editor button  -->
  disable-export <!-- boolean (default: false) - hide PNG export button  -->
  disable-code-inspector <!-- boolean (default: false) - hide spec viewer button   -->
  loading <!-- boolean (default: true) - show a loading animation that fills the container. When providing a complete string, the chart will auto-render and this will be set to false. If streaming: raw json text data will be incrementally displayed here until complete and validated, then the chart is rendered.  -->
>
</clabs-chat-chart>
```

### Vega formatting for content attribute:
Vega specifications (i.e specs) are JSON objects containing everything needed to render charts in one shot:

```json
{
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json", //link to Vega-lite schema to interpret attributes (Only V5 is supported)
  "data", //can contain a 'values' array of data points or 'url' string linking to a dataset
  "encoding", //maps axes/colors/sizes to specific columns
  "config", //global style guide to apply edits to every option in Vega-lite
  //ADVANCED OPTIONS
  "repeat", //contains a 'columns' array of column names or an object with 'column' and 'rows'. If repeat is enabled, the entire spec should be placed in 'spec' below:
  "spec", //sub-specification containing all attributes above (ONLY if repeat is defined)
  "layer", //enables layered-charts, array of spec objects with all the above attributes (data, encoding, config), the core parent config will be retooled to force-apply styling to children with the carbonify option
}
```

Simple bar chart specification:
```json
{
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "values": [
      {"category": "A", "value": 20},
      {"category": "B", "value": 40},
      {"category": "C", "value": 60}
      ]
    },
    "mark": "bar",
    "encoding": {
      "x": {"field": "category", "type": "nominal", "axis": {"title": "Category"}},
      "y": {"field": "value", "type": "quantitative", "axis": {"title": "Value"}}
    }
  }
}
```
Note: enabling `carbonify` in &lt;clabs-chat-chart&gt; will append a `config` field and extensively edit the specification to apply Carbon Design styling, while retaining all unique user styling.

### Usage inside Chat within the JSON conversation object:
If specified within a valid JSON `conversation` attribute: 

```html
<clabs-chat
conversation = '[
  {
  "origin":"user",
  "timestamp":"7:01pm",
  "elements":
      [
        {"type": "text", "content": "Give me line chart using price over time"}
      ]
  },
  {
  "origin":"bot",
  "timestamp":"7:06pm",
  "elements":
      [
        {"type": "text", "content": "Here is the chart your requested:"}
        ,
        {"type": "chart",
        "content":'{"$schema":"https://vega.github.io/schema/vega-lite/v5.json","data": ..., "encoding": ...}'}
      ]
  }
]' >
</clabs-chat>
```

### Usage as plain text response:
If streaming or using plain `rawText` field, simply place the JSON specification in you message item using a \\n then auto-parsing will identify it.

```html
<clabs-chat
conversation = [
  {
  "origin":"user",
  "timestamp":"7:01pm",
  "rawText": "Give me line chart using price over time"
  },
  {
  "origin":"bot",
  "timestamp":"7:06pm",
  "rawText": 'Here is the chart you requested\n {"$schema":"https://vega.github.io/schema/vega-lite/v5.json","data": ..., "encoding": ...}'
  }
]>
</clabs-chat>
```


