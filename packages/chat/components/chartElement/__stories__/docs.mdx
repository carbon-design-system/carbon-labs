import { ArgTypes, Markdown, Meta } from '@storybook/blocks';
import { cdnJs, cdnCss } from '../../../../../globals/internal/storybook-cdn';
import * as ChartElementStories from './chartElement.stories';
import packageJson from '../../../package.json';

<Meta of={ChartElementStories} />

# Chart Handbook
<br/>
* **Initiative owner(s):** Owen Cornec
* **Status:** Draft
* **Target library:** TBD
* **Target library maintainer(s) / PR Reviewer(s):** N/A
* **Support channel:** `#carbon-labs`

## Table of Contents

- [Overview](#overview)
- [Installation](#installation)
  - [JS via import](#js-via-import)
- [Implementation](#implementation)
  - [Independent Usage](#independent-usage)
  - [&lt;clabs-chat-chart&gt; attributes](#attributes)
  - [Events](#events)
- [Vega formatting](#vega-format)
  - [Simple chart specification](#simple-example)
  - [Effects of carbonify field](#carbonification)
  - [Usage inside Chat within the JSON conversation object](#usage-with-json)
  - [Usage as plain text response](#usage-with-text)
- [Merging Vega-lite and Carbon Charts](#merging-carbon-and-vega)
  - [Choice of Vega-lite](#choice-of-vega)
  - [Vega as the back bone, Carbon as the output](#vega-and-carbon)
  - [Advantages](#advantages)
  - [Disadvantages](#disadvantages)


## Overview
<a id="overview"></a>
**The Chart component renders a large variety of Charts by consuming Vega-lite JSON specifications in its `content` attribute. These can easily be generated by LLMs, enabling true conversation-based chart design, editing and streaming.**

Like all components in Carbon Labs, Charts are invoked inside the core Chat component but can easily be imported separately and used independently. By default the `carbonify` attribute is enabled which extensively edits the specification styling in order to recreate Carbon Charts styling. This overrides and edits all axis/legend/title/encoding/gradient/colorscale values to display the specification as a clone of classic Carbon Charts.

* Vega-lite reference: [vega.github.io](https://vega.github.io/vega-lite/)
* Carbon Charts reference:
[charts.carbondesignsystem.com](https://charts.carbondesignsystem.com/?path=/story/docs--welcome)

**Feel free to contact Owen Cornec (on Slack or o.cornec@ibm.com) if you have any issues/questions**

## Installation
<a id="installation"></a>
Here's a quick example to get you started.

### JS (via import)
<a id="js-via-import"></a>
```javascript
import '@carbon-labs/ai-chat-chart/es/index.js';
```

## Implementation
<a id="implementation"></a>
### Independent Usage:
<a id="independent-usage"></a>
```html
<clabs-chat-chart
  content = "{ ... }"
  container-height = "500px"
  container-width = "100%"
  theme = "g100"
>
</clabs-chat-chart>
```

### &lt;clabs-chat-chart&gt; attributes
<a id="chart-attributes"></a>
<table><thead><tr><td>**Attribute**</td><td>**Type**</td><td>**Default**</td><td>**Description**</td></tr></thead><tbody><tr><td>`content`</td><td>string</td><td>empty</td><td>stringified JSON object defining a Vega-lite V5 chart specification. Specifications must contain $schema, data and encoding</td></tr><tr><td>`debug`</td><td>boolean</td><td>false</td><td>shows specification editor button and displays all errors in component when in error mode, otherwise show: Chart failed to render, see console for more details</td></tr><tr><td>`container-height`</td><td>string</td><td>&quot;300px&quot;</td><td>valid CSS string to define chart height, applied to chart container while specification fills the parent container height</td></tr><tr><td>`container-width`</td><td>string</td><td>&quot;100%&quot;</td><td>same as container-height, a CSS string to define the width, applied to chart container</td></tr><tr><td>`render-method`</td><td>string</td><td>&quot;canvas&quot;</td><td>render using &quot;svg&quot; (easier to inspect in the DOM) or &quot;canvas&quot; (better performance)</td></tr><tr><td>`theme`</td><td>string</td><td>&quot;g100&quot;</td><td>this value is either &quot;g100&quot; or &quot;white&quot; and displays the chart using Carbon Chart theme colors.</td></tr><tr><td>`carbonify`</td><td>boolean</td><td>true</td><td>extensively redefine the &quot;config&quot; field of the specification to apply Carbon Chart styling to chart defined in the specification</td></tr><tr><td>`enable-legend-filtering`</td><td>boolean</td><td>false</td><td>enable filtering of data points when clicking legend</td></tr><tr><td>`enable-tooltip`</td><td>boolean</td><td>false</td><td>enable tooltip in the chart component</td></tr><tr><td>`enable-zooming`</td><td>boolean</td><td>false</td><td>enable user-zooming in the chart component</td></tr><tr><td>`enable-brushing`</td><td>boolean</td><td>false</td><td>enable user-brush selection to fetch groups of elements</td></tr><tr><td>`disable-options`</td><td>boolean</td><td>false</td><td>disable all chart option buttons, supercedes all other individual button options below</td></tr><tr><td>`disable-fullscreen`</td><td>boolean</td><td>false</td><td>hide fullscreen button</td></tr><tr><td>`disable-editor`</td><td>boolean</td><td>false</td><td>hide vega editor button</td></tr><tr><td>`disable-export`</td><td>boolean</td><td>false</td><td>hide PNG export button</td></tr><tr><td>`disable-code-inspector`</td><td>boolean</td><td>false</td><td>hide spec viewer button</td></tr><tr><td>`loading`</td><td>boolean</td><td>true</td><td>show loading animation. When content is provided chart will auto-render and this will false. If streaming: raw data is incrementally displayed until complete and rendered</td></tr></tbody></table>


### &lt;clabs-chat-chart&gt; events
<a id="events"></a>
<table>
    <tr>
        <td>**Event listener name**</td>
        <td>**Trigger condition**</td>
    </tr>
    <tr>
        <td>`on-chart-specification-ready`</td>
        <td>Chart is fully parsed/rendered post-carbonification</td>
    </tr>
    <tr>
        <td>`on-chart-error`</td>
        <td>Rendering encountered an error</td>
    </tr>
    <tr>
        <td>`on-chart-single-selection`</td>
        <td>Selection event found one object selected</td>
    </tr>
    <tr>
        <td>`on-chart-multi-selection`</td>
        <td>Selection event found a range of quantitative/qualitative values</td>
    </tr>
</table>


## Vega formatting
<a id="vega-format"></a>
Vega specifications (i.e specs) are JSON objects containing everything needed to render charts in one shot.

**These must be provided as stringified objects in the `content` field:**
```json
{
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json", //link to Vega-lite schema to interpret attributes (Only V5 is supported)
  "data", //can contain a 'values' array of data points or 'url' string linking to a dataset
  "encoding", //maps axes/colors/sizes to specific columns
  "config", //global style guide to apply edits to every option in Vega-lite
  //ADVANCED OPTIONS
  "repeat", //contains a 'columns' array of column names or an object with 'column' and 'rows'. If repeat is enabled, the entire spec should be placed in 'spec' below:
  "spec", //sub-specification containing all attributes above (ONLY if repeat is defined)
  "layer", //enables layered-charts, array of spec objects with all the above attributes (data, encoding, config), the core parent config will be retooled to force-apply styling to children with the carbonify option
}
```

### Simple bar chart specification:
<a id="simple-example"></a>
```json
{
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "values": [
      {"category": "A", "value": 20},
      {"category": "B", "value": 40},
      {"category": "C", "value": 60}
      ]
    },
    "mark": "bar",
    "encoding": {
      "x": {"field": "category", "type": "nominal", "axis": {"title": "Category"}},
      "y": {"field": "value", "type": "quantitative", "axis": {"title": "Value"}}
    }
  }
}
```

### Effects of carbonify field:
<a id="carbonification"></a>
Enabled by default, the `carbonify` field in &lt;clabs-chat-chart&gt; will append a `config` object to extensively edit the specification to apply Carbon Design styling, while retaining all unique user styling. Disabling it will render the specification as is, useful for debugging.

### Usage inside Chat within the JSON conversation object:
<a id="usage-with-json"></a>
If specified within a valid JSON `conversation` attribute:

```html
<clabs-chat
conversation = conversationJSON >
</clabs-chat>
```
With the `conversationJSON` object as follows:

```json
[
  {
  "origin":"user",
  "timestamp":"7:01pm",
  "elements":
      [
        {"type": "text", "content": "Give me line chart using price over time"}
      ]
  },
  {
  "origin":"bot",
  "timestamp":"7:06pm",
  "elements":
      [
        {"type": "text", "content": "Here is the chart your requested:"}
        ,
        {"type": "chart", "content": ChartJSONString }
      ]
  }
]
```
With `ChartJSONString` as follows:
```json
'{"$schema":"https://vega.github.io/schema/vega-lite/v5.json","data": [], "encoding": {}}'
```

### Usage as plain text response:
<a id="usage-with-text"></a>
If streaming or using plain `rawText` field, simply place the JSON specification in you message item using a \\n then auto-parsing will identify it.

```html
<clabs-chat
conversation = [
  {
  "origin":"user",
  "timestamp":"7:01pm",
  "rawText": "Give me line chart using price over time"
  },
  {
  "origin":"bot",
  "timestamp":"7:06pm",
  "rawText": 'Here is the chart you requested\n {"$schema":"https://vega.github.io/schema/vega-lite/v5.json","data": ..., "encoding": ...}'
  }
]>
</clabs-chat>
```

## Merging Vega-lite and Carbon Charts
<a id="merging-carbon-and-vega"></a>

### Choice of Vega-lite
<a id="choice-of-vega"></a>
Countless visualization libraries are available and provide many features to generate and visualize charts. Many were tested by the Visual AI Lab with a variety of models.

Vega-lite was chosen due to it's **longevity**, **succinctness** and **common usage**, most LLMs have a large training corpus on a variety of Vega-lite specifications. We found this greatly improved reliability during LLM generation, as hallucinations and formatting/versioning errors are common in this space. Additionally, Vega only requires a single JSON object to display any type of chart, which forgoes the need for multiple context-dependent calls.

### Vega as the back bone, Carbon as the output
<a id="vega-and-carbon"></a>
Carbon Charts is an excellently designed, robust and production-ready library following core Carbon design guidelines. Regrettably without fine-tuning, generation accuracy is insufficient due to a lack of examples in common training data. Carbon Charts also requires a predefined HTML chart tag (such as &lt;AreaChart&gt; &lt;SimpleBarChart&gt; etc) as well as separate `options` and `data` fields. This requires multiple queries, with the additional complexity of shared context and custom doctoring/sanitization.

Yet despite it's generative edge, standard Vega styling is ill-fitting in any Carbon environment which prohibits any product-side adoption. This led us to adopt a hybrid approach, using Vega-lite as a boilerplate for querying LLMs then programmatically adding and editing styles/interactions/scaling. **This component is not a replacement for Carbon Charts**: it is primarily meant to reliably handle highly-variable LLM-generated content and allow creation and editing through conversation.

### Advantages
<a id="advantages"></a>
With Vega a single JSON object string is all that is needed, thus charts can be generated in a single call to a model. This enables quicker response times, product-ready reliability and token-by-token streaming. Additionally, Vega-specific features are now possible, such as repeating charts (Comparative chart over a matrix of data fields) and multi-layer charts (Multiple types of any chart layered in sequence). We avoid designed the system to adapt to any model and refrain from ferrying any data into the model. Only column names are sent in, saving on token usage and bandwidth. All data should be specified post-hoc in `spec.data.values` or `spec.data.url`. Finally, the `config` system allows us to strategically override styles globally, given the unpredictability of LLM responses it's imperative to retain specific changes requested by users and override styling randomly appended by the generation process.

### Disadvantages
<a id="disadvantages"></a>
Some chart types in Classic Carbon Charts are not currently supported, such as WordClouds, Radar Charts, Treemaps, Network/Tree Diagrams and Alluvial/Flow charts. Touch/mobile features have not been tested and attributes are still subject to change. Features such as legend interactions to filter out data, viewing the source data as a table, locale support, and are not currently implemented as well. (subject to change)


